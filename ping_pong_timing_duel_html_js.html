<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ping-Pong Timing Duel</title>
  <style>
    :root{
      --bg:#0f1220;--panel:#171a2b;--accent:#58e1ff;--accent2:#ff7ad9;--text:#e8ecff;--muted:#aab1d6;--good:#6dff9c;--bad:#ff8484
    }
    *{box-sizing:border-box} body{margin:0;background:radial-gradient(1200px 600px at 70% -10%,#1b2147 0%,#0f1220 60%,#0a0d1a 100%);color:var(--text);font-family:ui-sans-serif,system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;}
    .wrap{min-height:100svh;display:grid;place-items:center;padding:24px}
    .card{width:min(960px,95vw);background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:18px;box-shadow:0 10px 40px rgba(0,0,0,.45);padding:20px 20px 14px}
    h1{margin:0 0 8px;font-weight:800;letter-spacing:.2px}
    .sub{color:var(--muted);margin-bottom:12px}
    .board{position:relative;background:linear-gradient(180deg,#0b0f1d,#0b0e1a);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px}
    canvas{width:100%;height:auto;max-height:62vh;display:block;border-radius:10px;background:linear-gradient(180deg,#0a0f1c,#0a101a)}
    .hud{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px}
    .pill{border:1px solid rgba(255,255,255,.12);padding:8px 12px;border-radius:999px;background:rgba(255,255,255,.04);color:var(--text);font-weight:700}
    .accent{color:var(--accent)} .accent2{color:var(--accent2)}
    .btns{margin-left:auto;display:flex;gap:8px}
    button{all:unset;border:1px solid rgba(255,255,255,.14);padding:8px 12px;border-radius:10px;background:rgba(255,255,255,.06);cursor:pointer;transition:.2s ease;}
    button:hover{transform:translateY(-1px);background:rgba(255,255,255,.1)}
    .note{color:var(--muted);font-size:.95rem;margin-top:10px}
    .toast{position:absolute;inset:0;display:grid;place-items:center;pointer-events:none}
    .toast span{background:rgba(0,0,0,.55);backdrop-filter:blur(6px);padding:10px 16px;border:1px solid rgba(255,255,255,.15);border-radius:999px;font-weight:800}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Ping-Pong Timing Duel üèì</h1>
    <div class="sub">Enter „Çí„Çø„Ç§„Éü„É≥„Ç∞„Çà„ÅèÊäº„Åó„Å¶Êâì„Å°Ëøî„Åô„ÄÇÂÖàÂèñ <strong>5 ÁÇπ</strong>„ÅßÂãùÂà©„ÄÇ„Ç∑„É≥„Éó„É´„Å™„Çø„Ç§„Éü„É≥„Ç∞ÂçìÁêÉ„ÄÇ</div>

    <div class="board">
      <canvas id="game" width="960" height="480" aria-label="game canvas"></canvas>
      <div class="toast" id="toast" aria-live="polite" hidden><span id="toastText"></span></div>
      <div class="hud">
        <div class="pill">P1 <span class="accent">(Â∑¶)</span>: <span id="p1">0</span></div>
        <div class="pill">P2 <span class="accent2">(Âè≥)</span>: <span id="p2">0</span></div>
        <div class="pill">„É©„É™„Éº: <span id="rally">0</span></div>
        <div class="btns">
          <button id="start">‚ñ∂ Start / Pause (Space)</button>
          <button id="reset">‚Ü∫ Reset</button>
          <button id="mode">„É¢„Éº„Éâ: <span id="modeLabel">„ÇΩ„É≠</span></button>
        </div>
      </div>
      <div class="note">Êìç‰Ωú: <strong>Enter</strong> „ÅßÊâì„Å°Ëøî„Åó„ÄÇSpace „Åß‰∏ÄÊôÇÂÅúÊ≠¢/ÂÜçÈñã„ÄÇ„É¢„Éº„Éâ: <strong>„ÇΩ„É≠</strong>„ÅØ‰∏Ä‰∫∫„ÅßÁ∑¥Áøí„ÄÅ<strong>ÂØæÊà¶</strong>„ÅØ‰∫§‰∫í„Çø„Éº„É≥Âà∂„Åß2‰∫∫„Éó„É¨„Ç§ÔºàÂêå„Åò„Ç≠„Éº„Éú„Éº„ÉâÔºâ„ÄÇ</div>
    </div>
  </div>
</div>

<script>
(() => {
  const cvs = document.getElementById('game');
  const ctx = cvs.getContext('2d');
  const p1El = document.getElementById('p1');
  const p2El = document.getElementById('p2');
  const rallyEl = document.getElementById('rally');
  const toast = document.getElementById('toast');
  const toastText = document.getElementById('toastText');
  const startBtn = document.getElementById('start');
  const resetBtn = document.getElementById('reset');
  const modeBtn = document.getElementById('mode');
  const modeLabel = document.getElementById('modeLabel');

  const W = cvs.width, H = cvs.height;

  const state = {
    running: false,
    mode: 'solo', // 'solo' | 'versus'
    rally: 0,
    scores: { p1: 0, p2: 0 },
    serveTo: 'p1',
    ball: { x: W/2, y: H/2, vx: 320, vy: 0, r: 10 },
    paddles: {
      left: { x: 30, y: H/2-45, w: 12, h: 90, color: '#58e1ff' },
      right:{ x: W-42, y: H/2-45, w: 12, h: 90, color: '#ff7ad9' },
    },
    hitWindow: 110, // ms window to hit when ball reaches paddle zone
    lastSide: 'p2',
    over: false
  };

  function resetBall(side) {
    const dir = side === 'p1' ? 1 : -1;
    state.ball.x = side === 'p1' ? state.paddles.left.x + 26 : state.paddles.right.x - 26;
    state.ball.y = H/2;
    const speed = 300 + Math.min(state.rally*12, 260);
    state.ball.vx = speed * dir;
    state.ball.vy = (Math.random()-0.5) * 160;
  }

  function drawCourt(){
    // background
    const g = ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,'#0a1222'); g.addColorStop(1,'#08101b');
    ctx.fillStyle = g; ctx.fillRect(0,0,W,H);
    // center line
    ctx.setLineDash([10,15]); ctx.strokeStyle = 'rgba(255,255,255,.12)'; ctx.lineWidth = 3; ctx.beginPath(); ctx.moveTo(W/2,20); ctx.lineTo(W/2,H-20); ctx.stroke(); ctx.setLineDash([]);
    // edges glow
    ctx.strokeStyle = 'rgba(88,225,255,.25)'; ctx.lineWidth = 4; ctx.strokeRect(8,8,W-16,H-16);
  }

  function drawPaddles(){
    for(const p of [state.paddles.left, state.paddles.right]){
      ctx.fillStyle = p.color; ctx.globalAlpha = .95; ctx.fillRect(p.x, p.y, p.w, p.h); ctx.globalAlpha = 1;
      // glow
      ctx.shadowColor = p.color; ctx.shadowBlur = 16; ctx.strokeStyle = 'rgba(255,255,255,.25)'; ctx.strokeRect(p.x-.5, p.y-.5, p.w+1, p.h+1); ctx.shadowBlur = 0;
    }
  }

  function drawBall(){
    const b = state.ball;
    const grd = ctx.createRadialGradient(b.x-4,b.y-4,2,b.x,b.y,14);
    grd.addColorStop(0,'#fff'); grd.addColorStop(1,'#8fdcff');
    ctx.fillStyle = grd; ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill();
    // trail
    ctx.globalAlpha = .15; ctx.fillStyle = '#58e1ff'; ctx.beginPath(); ctx.arc(b.x-b.vx*0.02,b.y-b.vy*0.02,b.r*1.4,0,Math.PI*2); ctx.fill(); ctx.globalAlpha = 1;
  }

  function drawUI(){
    // hit zones
    ctx.fillStyle = 'rgba(255,255,255,.06)';
    ctx.fillRect(state.paddles.left.x + state.paddles.left.w + 6, 30, 46, H-60);
    ctx.fillRect(state.paddles.right.x - 52, 30, 46, H-60);
    // text
    ctx.fillStyle = 'rgba(255,255,255,.7)'; ctx.font = '700 16px ui-sans-serif, system-ui';
    ctx.fillText('Enter „ÅßÊâì„Å°Ëøî„Åó', 24, 28);
  }

  function update(dt){
    if(!state.running || state.over) return;
    const b = state.ball;
    b.x += b.vx * dt; b.y += b.vy * dt;

    // bounce top/bottom
    if(b.y < 16 || b.y > H-16){ b.vy *= -1; b.y = Math.max(16, Math.min(H-16, b.y)); }

    // paddle rectangles (for visual, we use timing, not collision)
    // scoring conditions: if ball passes beyond paddle x without a valid hit flag, it's a miss
    if (b.x < state.paddles.left.x - 10){ // right player scores
      point('p2');
    }
    if (b.x > state.paddles.right.x + state.paddles.right.w + 10){ // left player scores
      point('p1');
    }
  }

  function point(winner){
    state.scores[winner]++;
    p1El.textContent = state.scores.p1; p2El.textContent = state.scores.p2;
    state.rally = 0; rallyEl.textContent = state.rally;
    state.serveTo = winner === 'p1' ? 'p2' : 'p1';
    showToast(`${winner==='p1'?'P1':'P2'} „ÅÆ„Éù„Ç§„É≥„ÉàÔºÅ`);
    checkWin();
    if(!state.over) resetBall(state.serveTo);
  }

  function checkWin(){
    if(state.scores.p1 >= 5 || state.scores.p2 >= 5){
      state.over = true; state.running = false;
      const msg = state.scores.p1>state.scores.p2 ? 'P1 ÂãùÂà©ÔºÅ' : 'P2 ÂãùÂà©ÔºÅ';
      showToast(msg + '  ‚Ü∫ Reset „ÅßÂÜçÊà¶');
    }
  }

  let last=0; function loop(t){
    const now = t/1000; const dt = Math.min(0.033, now - (last||now)); last = now;
    drawCourt(); drawUI(); drawPaddles(); update(dt); drawBall();
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  function showToast(s, ms=1200){
    toastText.textContent = s; toast.hidden = false; clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>toast.hidden = true, ms);
  }

  // timing logic: Enter within time window when ball center is within hit zone X of your paddle
  function onHit(){
    if(state.over) return;
    const b = state.ball, L = state.paddles.left, R = state.paddles.right;
    const now = performance.now();

    // compute time to paddle plane
    // translate hit window in spatial terms: zone width proportional to |vx| and hitWindow
    const px = b.vx < 0 ? L.x + L.w + 6 : R.x - 6; // plane x to check
    const dist = Math.abs(px - b.x);
    const zonePx = Math.max(22, Math.abs(b.vx) * (state.hitWindow/1000));
    const inZone = dist <= zonePx;

    if(!inZone){
      // early/late: immediate lose point to opponent
      const winner = b.vx < 0 ? 'p2' : 'p1';
      showToast('„Çø„Ç§„Éü„É≥„Ç∞„Éü„Çπ‚Ä¶');
      point(winner);
      return;
    }

    // valid hit: reverse vx, add speed, tweak vy based on relative Y to paddle center
    const pad = b.vx < 0 ? L : R;
    const rel = (b.y - (pad.y + pad.h/2)) / (pad.h/2); // -1..1
    const speed = Math.min(Math.hypot(b.vx,b.vy)*1.06 + 20, 960);
    const dir = b.vx < 0 ? 1 : -1;
    b.vx = speed * dir;
    b.vy = (b.vy + rel*180) * 0.9;

    state.rally++; rallyEl.textContent = state.rally;

    // mini FX
    for(let i=0;i<16;i++) spark(b.x, b.y, dir);
  }

  // simple spark particles
  const sparks=[]; function spark(x,y,dir){
    sparks.push({x,y,vx:(Math.random()*120+60)*dir,vy:(Math.random()-0.5)*220,life:0.35});
  }
  (function drawSparks(){
    const now = performance.now()/1000; if(!drawSparks._last) drawSparks._last = now; const dt = Math.min(0.033, now-drawSparks._last); drawSparks._last = now;
    // update
    for(let i=sparks.length-1;i>=0;i--){ const s=sparks[i]; s.x+=s.vx*dt; s.y+=s.vy*dt; s.vy+=220*dt; s.life-=dt; if(s.life<=0) sparks.splice(i,1); }
    // draw after main loop using requestAnimationFrame hook
    requestAnimationFrame(()=>{
      ctx.save(); ctx.globalCompositeOperation='lighter';
      for(const s of sparks){ ctx.globalAlpha = Math.max(0,s.life*2.2); ctx.fillStyle = '#b2f7ff'; ctx.beginPath(); ctx.arc(s.x,s.y,3,0,Math.PI*2); ctx.fill(); }
      ctx.restore();
    });
    requestAnimationFrame(drawSparks);
  })();

  // controls
  function toggle(){ state.running = !state.running; showToast(state.running?'ÂÜçÈñã':'‰∏ÄÊôÇÂÅúÊ≠¢', 800); }
  startBtn.onclick = toggle;
  resetBtn.onclick = () => { Object.assign(state, { running:false, mode:state.mode, rally:0, scores:{p1:0,p2:0}, serveTo:'p1', over:false }); p1El.textContent=0; p2El.textContent=0; rallyEl.textContent=0; resetBall('p1'); showToast('„É™„Çª„ÉÉ„Éà'); };
  modeBtn.onclick = () => { state.mode = state.mode==='solo'?'versus':'solo'; modeLabel.textContent = state.mode==='solo'?'„ÇΩ„É≠':'ÂØæÊà¶'; showToast(`„É¢„Éº„Éâ: ${state.mode==='solo'?'„ÇΩ„É≠':'ÂØæÊà¶'}`, 900); };

  window.addEventListener('keydown', (e)=>{
    if(e.code==='Enter'){ e.preventDefault(); onHit(); }
    if(e.code==='Space'){ e.preventDefault(); toggle(); }
  });

  // initial
  resetBall('p1');
  showToast('Space „Åß Start / Enter „ÅßÊâì„Å°Ëøî„Åó', 1800);
})();
</script>
</body>
</html>
